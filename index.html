<!doctype html><html lang="en"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BetterBot DC ‚Äî Super (Safari‚ÄëProof)</title>
<!-- iOS Home Screen + favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
<link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
<link rel="apple-touch-icon" sizes="167x167" href="icon-167.png">
<link rel="apple-touch-icon" sizes="120x120" href="icon-120.png">
<link rel="icon" type="image/png" sizes="32x32" href="icon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="icon-16.png">
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<meta name="apple-mobile-web-app-title" content="BetterBotDC">
<meta name="theme-color" content="#0b1022">

<!-- Try WebLLM; if it fails, we fall back to Lite mode -->
<script defer src="https://unpkg.com/@mlc-ai/web-llm/dist/web-llm.min.js"></script>
<style>
:root{--bg:#0b1022;--panel:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--accent:#1e3a8a;--accent2:#2563eb;--danger:#ef4444;--ok:#22c55e}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
.container{max-width:1060px;margin:0 auto;padding:18px}
.header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 12px;border-radius:12px;background:var(--accent2);color:#fff;font-weight:700;border:1px solid #1b3b8f;cursor:pointer}
.btn.ghost{background:transparent;color:#cbd5e1;border:1px solid #223047}
.btn.secondary{background:var(--accent)}
.btn.warn{background:var(--danger);border-color:#b91c1c}
.btn.ok{background:var(--ok);border-color:#15803d}
.input,select{padding:9px;border-radius:12px;border:1px solid #223047;background:#0b1324;color:#e5e7eb}
.panel{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:10px;margin:10px 0}
.row{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
.small{font-size:12px;color:var(--muted)}
.bubble{padding:10px 12px;border-radius:14px;margin:8px 0;line-height:1.4;overflow-wrap:anywhere}
.user{background:rgba(37,99,235,.15)}.bot{background:#0a1226}
#log{height:360px;overflow:auto}
iframe{border:0;border-radius:12px}
.tag{font-size:11px;padding:4px 8px;border-radius:999px;background:#1d4ed81f;border:1px solid #1d4ed866;color:#93c5fd}
.kpi{display:inline-flex;gap:6px;flex-wrap:wrap;align-items:center}
.kpi .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#1d4ed81a;border:1px solid #1d4ed84d}
.badge{font-size:11px;padding:4px 8px;border-radius:8px;background:#1d4ed81a;border:1px solid #1d4ed84d;color:#93c5fd}
</style></head><body>
<div class="container">
  <header class="header">
    <div><strong style="font-size:18px">BetterBot DC ‚Äî Super</strong>
      <div class="small">If local model can‚Äôt load on Safari, it auto-switches to <b>Local (Lite)</b>.</div>
    </div>
    <div class="row" style="margin:0">
      <span id="modeBadge" class="badge">Mode: detecting‚Ä¶</span>
      <button id="blueBtn" class="btn secondary">Blue ON</button>
      <button id="installBtn" class="btn ghost" style="display:none">Install app</button>
      <button id="makePwaBtn" class="btn">Generate PWA files</button>
    </div>
  </header>

  <!-- Provider + Keys (optional) -->
  <section class="panel">
    <div class="row">
      <select id="provider" class="input" style="max-width:260px">
        <option value="auto">Auto (OpenAI ‚Üí DeepSeek ‚Üí HF ‚Üí Local/ Lite)</option>
        <option value="openai">OpenAI only</option>
        <option value="deepseek">DeepSeek only</option>
        <option value="hf">Hugging Face only</option>
        <option value="local" selected>Local (WebLLM)</option>
        <option value="lite">Local (Lite)</option>
      </select>
      <select id="localModel" class="input" style="max-width:300px">
        <option value="Llama-3.2-1B-Instruct-q4f16_1-MLC">Llama 3.2 1B (tiny)</option>
        <option value="Llama-3.2-3B-Instruct-q4f16_1-MLC" selected>Llama 3.2 3B</option>
      </select>
      <span class="small">Tip: choose <b>Lite</b> if Safari blocks WebLLM.</span>
    </div>
    <div class="row">
      <input id="oaKey" class="input" placeholder="OpenAI API Key (optional)"/>
      <input id="oaModel" class="input" value="auto" placeholder="OpenAI model"/>
      <input id="dsKey" class="input" placeholder="DeepSeek Key (optional)"/>
      <input id="dsModel" class="input" value="auto" placeholder="DeepSeek model"/>
      <input id="hfKey" class="input" placeholder="Hugging Face Token (optional)"/>
      <input id="hfModel" class="input" value="google/gemma-2-2b-it" placeholder="HF model"/>
    </div>
    <div class="row">
      <button class="btn" id="saveKeysBtn">Save keys</button>
      <button class="btn ghost" id="exportKeysBtn">Export</button>
      <label class="btn ghost" for="importKeysFile" style="cursor:pointer">Import</label>
      <input id="importKeysFile" type="file" accept=".json" style="display:none">
      <button class="btn warn" id="forgetKeysBtn">Forget</button>
    </div>
    <div class="kpi" id="usage"><span class="pill">Last: ‚Äî</span><span class="pill">Total: ‚Äî</span><span class="pill">By provider: ‚Äî</span></div>
  </section>

  <!-- User + Manual Memory -->
  <section class="panel">
    <div class="row">
      <input id="name" class="input" value="Dhruv" style="max-width:160px"/>
      <input id="ints" class="input" value="Roblox, Mama" style="min-width:220px"/>
      <button class="btn ok" id="rememberBtn">Remember last</button>
      <button class="btn ghost" id="viewMemBtn">View memory</button>
      <button class="btn warn" id="forgetMemBtn">Forget memory</button>
    </div>
    <div class="small">Manual memory: press <b>Remember last</b> after you send a message.</div>
  </section>

  <!-- Music -->
  <section class="panel">
    <div class="small" style="margin-bottom:6px">Music station</div>
    <div class="row">
      <button class="btn" onclick="setStation('https://www.youtube.com/embed/videoseries?list=PLMC9KNkIncKtPzgY-5rmhvj7fax8fdxoj')">üé§ Ed YouTube</button>
      <button class="btn" onclick="setStation('https://open.spotify.com/embed/artist/6eUKZXaKkcviH0Ku9w2n3V')">üé§ Ed Spotify</button>
      <input id="customUrl" class="input" placeholder="Paste YouTube/Spotify EMBED URL"/>
      <button class="btn ghost" onclick="setStation(document.getElementById('customUrl').value)">Use link</button>
    </div>
    <div class="panel" style="padding:0"><iframe id="playerFrame" width="100%" height="180" allow="autoplay; encrypted-media; picture-in-picture" loading="lazy"></iframe></div>
  </section>

  <!-- Sessions -->
  <section class="panel">
    <div class="row">
      <span class="tag">Chats</span>
      <select id="chatSelect" class="input" style="max-width:320px"></select>
      <button class="btn" onclick="newChat()">New</button>
      <button class="btn ghost" onclick="saveChat()">Save</button>
      <button class="btn ghost" onclick="downloadChat()">Download</button>
      <button class="btn warn" onclick="deleteChat()">Delete</button>
    </div>
    <div class="small">Stored locally in your browser.</div>
  </section>

  <!-- Chat -->
  <section class="panel">
    <div id="log"></div>
    <div class="row">
      <input id="msg" class="input" placeholder="Type a message‚Ä¶ (Enter to send)"/>
      <button class="btn" onclick="send()">Send</button>
      <button id="micBtn" class="btn secondary" onclick="toggleMic()">üéôÔ∏è Mic</button>
      <button id="ttsBtn" class="btn ghost" onclick="toggleTTS()">üîä Speak: Off</button>
      <button class="btn ghost" onclick="testProvider()">Test</button>
      <button class="btn warn" onclick="clearChat()">Clear</button>
    </div>
    <div id="diag" class="small"></div>
  </section>

  <section class="panel"><div class="small"><b>PWA:</b> Click ‚ÄúGenerate PWA files‚Äù, then serve over localhost/HTTPS to see the Install button.</div></section>
</div>

<script>
/* ---------- helpers/state ---------- */
function $(s){return document.querySelector(s)}
var logEl=$('#log'), diag=$('#diag'), modeBadge=$('#modeBadge');
var OPENAI_CANDIDATES=['gpt-4o-mini','gpt-4.1-mini','gpt-4o','gpt-4.1'];
var DEEPSEEK_CANDIDATES=['deepseek-v3','deepseek-reasoner','deepseek-chat'];
var speakReplies=false, currentSessionId=null;
var chat=[{role:'bot',text:"Hi! I'm BetterBot DC. Type /help to see commands."}];
function render(){var html=''; for(var i=0;i<chat.length;i++){var m=chat[i]; html+='<div class="bubble '+(m.role==='user'?'user':'bot')+'"><div class="small">'+(m.role==='user'?(getUserName()||'Me'):'BetterBot DC')+'</div><div>'+String(m.text||'').replace(/</g,'&lt;')+'</div></div>'} logEl.innerHTML=html; logEl.scrollTop=logEl.scrollHeight}
render(); function clearChat(){chat=[{role:'bot',text:'Chat cleared. What next?'}];render()}

/* ---------- keys ---------- */
var KEY_STORE='bb_keys_v2';
function getKeys(){try{return JSON.parse(localStorage.getItem(KEY_STORE)||'{}')}catch(e){return{}}}
function setKeys(o){localStorage.setItem(KEY_STORE,JSON.stringify(o))}
function loadKeysToUI(){var k=getKeys(); if(k.provider)$('#provider').value=k.provider;
  if(k.oa)$('#oaKey').value=k.oa; if(k.oaModel)$('#oaModel').value=k.oaModel||'auto';
  if(k.ds)$('#dsKey').value=k.ds; if(k.dsModel)$('#dsModel').value=k.dsModel||'auto';
  if(k.hf)$('#hfKey').value=k.hf; if(k.hfModel)$('#hfModel').value=k.hfModel||'google/gemma-2-2b-it';
  if(k.localModel)$('#localModel').value=k.localModel;}
function readKeys(){return{provider:$('#provider').value,oa:$('#oaKey').value.trim(),oaModel:$('#oaModel').value.trim(),ds:$('#dsKey').value.trim(),dsModel:$('#dsModel').value.trim(),hf:$('#hfKey').value.trim(),hfModel:$('#hfModel').value.trim(),localModel:$('#localModel').value}}
$('#saveKeysBtn').addEventListener('click',function(){setKeys(readKeys());alert('Saved on this device.')})
$('#forgetKeysBtn').addEventListener('click',function(){localStorage.removeItem(KEY_STORE);['oaKey','dsKey','hfKey'].forEach(function(id){var el=document.getElementById(id);if(el)el.value=''});alert('Keys cleared.')})
$('#exportKeysBtn').addEventListener('click',function(){var blob=new Blob([JSON.stringify(readKeys(),null,2)],{type:'application/json'});var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='betterbot-keys.json';a.click();setTimeout(function(){URL.revokeObjectURL(a.href)},1000)})
$('#importKeysFile').addEventListener('change',function(e){var f=e.target.files&&e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(){try{setKeys(JSON.parse(r.result));loadKeysToUI();alert('Keys imported.')}catch(e){alert('Invalid JSON.')}};r.readAsText(f)})
loadKeysToUI();

/* ---------- manual memory ---------- */
function getUserName(){return $('#name').value||'Dhruv'}
function memKey(){return 'bb_memory_'+getUserName()}
function getMem(){try{return JSON.parse(localStorage.getItem(memKey())||'[]')}catch(e){return[]}}
function setMem(a){localStorage.setItem(memKey(),JSON.stringify(a))}
function rememberLatest(){var last=null; for(var i=chat.length-1;i>=0;i--){if(chat[i].role==='user'){last=chat[i].text;break}} if(!last){alert('No recent user message.');return} var mem=getMem(); mem.unshift(last); setMem(mem.slice(0,500)); alert('Saved to memory for '+getUserName());}
function viewMem(){var m=getMem(); alert(m.length?('Memory for '+getUserName()+':\n\n- '+m.join('\n- ')):'No memory yet.')}
function forgetMem(){if(confirm('Forget ALL memory for '+getUserName()+'?')){setMem([]);alert('Memory cleared.')}}
$('#rememberBtn').addEventListener('click',rememberLatest);$('#viewMemBtn').addEventListener('click',viewMem);$('#forgetMemBtn').addEventListener('click',forgetMem);

/* ---------- system prompt ---------- */
function buildSystem(){var mem=getMem();var name=getUserName();var ints=($('#ints').value||'').split(',').map(function(s){return s.trim()}).filter(Boolean).join(', ');var memBlock=mem.length?('\nKnown memories (keep consistent):\n- '+mem.slice(0,50).join('\n- ')):'';return 'You are DRAR CARS BetterBot DC. Be friendly and concise.\nUser name: '+name+'\nInterests: '+(ints||'none')+memBlock}

/* ---------- usage pills ---------- */
var usageState={last:null,total:0,by:{}}; function addUsage(provider,usage){if(!usage||usage.total_tokens==null){usageState.last=provider+': n/a'}else{usageState.last=provider+': '+usage.total_tokens;usageState.total+=usage.total_tokens;usageState.by[provider]=(usageState.by[provider]||0)+usage.total_tokens}
var pills=$('#usage').querySelectorAll('.pill'); if(pills[0])pills[0].textContent='Last: '+(usageState.last||'‚Äî'); if(pills[1])pills[1].textContent='Total: '+(usageState.total||0);
if(pills[2]){var s=[];for(var k in usageState.by){s.push(k+' '+usageState.by[k])} pills[2].textContent='By provider: '+(s.length?s.join(', '):'‚Äî')}}

/* ---------- history ---------- */
function historyForAPI(){var h=[], start=Math.max(0,chat.length-6); for(var i=start;i<chat.length;i++){var m=chat[i];h.push({role:m.role==='user'?'user':'assistant',content:m.text})} return h}

/* ---------- cloud providers ---------- */
function safeDiag(label,msg){diag.textContent=label+': '+(msg||'error')}
async function callOpenAI(p){var key=($('#oaKey').value||'').trim(); if(!key)throw new Error('skip'); var mf=($('#oaModel').value||'auto').trim().toLowerCase(); var list=(mf&&mf!=='auto')?[mf]:OPENAI_CANDIDATES; var lastErr=null;
for(var i=0;i<list.length;i++){var model=list[i]; var res=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({model:model,messages:[{role:'system',content:p.system}].concat(p.history).concat([{role:'user',content:p.userText}]),temperature:0.7,max_tokens:300})});
if(res.ok){var data=await res.json(); addUsage('OpenAI',data.usage); var c=(data.choices&&data.choices[0]&&data.choices[0].message&&data.choices[0].message.content)||''; return (c||'(no reply)').trim()} else {lastErr=await res.text().catch(function(){return 'HTTP '+res.status})}}
safeDiag('OpenAI',lastErr||'model error'); throw new Error('OpenAI: '+(lastErr||'model error'))}
async function callDeepSeek(p){var key=($('#dsKey').value||'').trim(); if(!key)throw new Error('skip'); var mf=($('#dsModel').value||'auto').trim().toLowerCase(); var list=(mf&&mf!=='auto')?[mf]:DEEPSEEK_CANDIDATES; var lastErr=null;
for(var i=0;i<list.length;i++){var model=list[i]; var res=await fetch('https://api.deepseek.com/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({model:model,messages:[{role:'system',content:p.system}].concat(p.history).concat([{role:'user',content:p.userText}]),temperature:0.7,max_tokens:300})});
if(res.ok){var data=await res.json(); addUsage('DeepSeek',data.usage); var c=(data.choices&&data.choices[0]&&data.choices[0].message&&data.choices[0].message.content)||''; return (c||'(no reply)').trim()} else {lastErr=await res.text().catch(function(){return 'HTTP '+res.status})}}
safeDiag('DeepSeek',lastErr||'model error'); throw new Error('DeepSeek: '+(lastErr||'model error'))}
async function callHF(p){var key=($('#hfKey').value||'').trim(); if(!key)throw new Error('skip'); var model=($('#hfModel').value||'google/gemma-2-2b-it').trim();
var hist='';var h=p.history; for(var i=0;i<h.length;i++){hist+=(h[i].role==='user'?'User: ':'Assistant: ')+h[i].content+'\n'}
var prompt=p.system+'\n\n'+hist+'User: '+p.userText+'\nAssistant:'; var lastErr=null;
try{var res=await fetch('https://api-inference.huggingface.co/models/'+encodeURIComponent(model),{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({inputs:prompt,parameters:{max_new_tokens:300,temperature:0.7,return_full_text:false}})});
if(!res.ok){lastErr=await res.text().catch(function(){return 'HTTP '+res.status}); throw new Error(lastErr||'HF error')}
var data=await res.json(); addUsage('HF',null); var txt=''; if(Array.isArray(data)&&data[0]&&data[0].generated_text)txt=data[0].generated_text; else if(data&&data.generated_text)txt=data.generated_text; return (txt||'(no reply)').trim()}
catch(e){safeDiag('HF',e&&e.message||e); throw new Error('HF: '+(e&&e.message||e))}}

/* ---------- Local (WebLLM) ‚Äî Safari-proof loading ---------- */
var webllmEngine=null, webllmLoading=false, localMode='detecting'; // 'webllm'|'lite'
function setModeBadge(text){modeBadge.textContent='Mode: '+text}
async function waitForWebLLM(ms){var start=Date.now(); while(!(window&&window.webllm&&window.webllm.CreateMLCEngine)){ if(Date.now()-start>(ms||12000)) throw new Error('WebLLM library missing'); await new Promise(function(r){setTimeout(r,120)}) } return window.webllm.CreateMLCEngine}
async function ensureLocalWebLLM(){
  if(webllmEngine||webllmLoading) return;
  webllmLoading=true; diag.textContent='Loading local model‚Ä¶';
  try{
    var CreateMLCEngine=await waitForWebLLM(12000); // short wait; if fails, we fall back
    var modelId=$('#localModel').value;
    webllmEngine=await CreateMLCEngine(modelId,{gpuMemoryUtilization:0.6,streamProgressCallback:function(p){var pc=Math.round(((p&&p.progress)||0)*100); diag.textContent='Loading: '+pc+'%'}});
    localMode='webllm'; setModeBadge('Local (WebLLM)'); diag.textContent='Local model ready.';
  }catch(e){
    // hard fallback to Lite
    localMode='lite'; setModeBadge('Local (Lite)'); diag.textContent='Local (Lite) active.';
  }finally{webllmLoading=false}
}
async function callLocalWebLLM(p){
  await ensureLocalWebLLM();
  if(localMode!=='webllm') throw new Error('fallback'); // force router to try Lite
  var messages=[{role:'system',content:p.system}].concat(p.history).concat([{role:'user',content:p.userText}]);
  var out=''; var idx=chat.push({role:'bot',text:'‚Ä¶'})-1; render();
  var stream=await webllmEngine.chat.completions.create({messages:messages,stream:true,temperature:0.7,max_tokens:300});
  try{for await (var ch of stream){var d=(ch&&ch.choices&&ch.choices[0]&&ch.choices[0].delta&&ch.choices[0].delta.content)||''; out+=d; chat[idx].text=out||'‚Ä¶'; render()}}catch(e){}
  addUsage('Local',null); return (out||'(no reply)').trim()}

/* ---------- Local (Lite) engine ---------- */
function liteReply(user, sys){
  var t=user.trim(), lc=t.toLowerCase();
  // commands
  if(t==='/help') return "Commands:\n/help ‚Ä¢ /time ‚Ä¢ /coin ‚Ä¢ /echo <text> ‚Ä¢ /clear ‚Ä¢ /roll 1d20 ‚Ä¢ /timer 10s ‚Ä¢ /sum <text>";
  if(t==='/time') return 'time: '+new Date().toLocaleString();
  if(t==='/coin') return Math.random()<0.5?'Heads!':'Tails!';
  if(/^\/echo\s+/.test(t)) return t.replace(/^\/echo\s+/,'');
  if(/^\/roll\s+(\d+)d(\d+)\s*$/i.test(t)){var m=t.match(/^\/roll\s+(\d+)d(\d+)\s*$/i),n=+m[1],sides=+m[2],arr=[],sum=0; n=Math.min(n,20); for(var i=0;i<n;i++){var r=1+Math.floor(Math.random()*sides);arr.push(r);sum+=r} return 'üé≤ '+arr.join(', ')+'  |  total='+sum}
  if(/^\/timer\s+(\d+)(s|m)$/i.test(t)){var mm=t.match(/^\/timer\s+(\d+)(s|m)$/i),num=+mm[1],unit=mm[2]; var ms=unit==='s'?num*1000:num*60000; setTimeout(function(){chat.push({role:'bot',text:'‚è∞ Timer done!'});render(); if(speakReplies)speakText('Timer done')},ms); return '‚è≥ timer set for '+num+unit}
  if(/^\/sum\s+/.test(t)){var txt=t.replace(/^\/sum\s+/,''); return liteSummarize(txt)}
  // small talk / memory aware
  if(/\bhello|hi|hey\b/.test(lc)) return 'hey '+(getUserName()||'there')+'! what should we build next?';
  if(/your name|who are you/i.test(t)) return "I'm BetterBot DC (Lite).";
  // fallback: short supportive reply
  var endings=["cool! want me to add more powers?","nice‚Äîtry /help for tricks","okay! want a timer or dice roll?","got it‚Äîwant music while we chat?"];
  return endings[Math.floor(Math.random()*endings.length)];
}
function liteSummarize(text){
  // ultra-simple freq summary
  var s=text.replace(/\s+/g,' ').trim(); if(!s) return '(nothing to summarize)';
  var sentences=s.split(/(?<=[.!?])\s+/).slice(0,12);
  var freq={}, words=s.toLowerCase().match(/[a-z']{3,}/g)||[];
  for(var i=0;i<words.length;i++){var w=words[i]; freq[w]=(freq[w]||0)+1}
  sentences.sort(function(a,b){
    function score(str){var sc=0, ws=(str.toLowerCase().match(/[a-z']{3,}/g)||[]); for(var j=0;j<ws.length;j++){sc+=freq[ws[j]]||0} return sc/Math.sqrt(str.length+1)}
    return score(b)-score(a)
  });
  return 'TL;DR:\n- '+sentences.slice(0,3).join('\n- ');
}
async function callLocalLite(p){
  var out=''; var idx=chat.push({role:'bot',text:'‚Ä¶'})-1; render();
  // pretend stream
  var reply=liteReply(p.userText,p.system);
  for(var i=0;i<reply.length;i+=8){await new Promise(function(r){setTimeout(r,10)}); out+=reply.slice(i,i+8); chat[idx].text=out; render()}
  return out.trim()
}

/* ---------- router ---------- */
function looksLikeAKey(s){return /(sk-[\w-]{10,}|hf_[\w-]{10,}|AIzaSy|ghp_[\w]{20,}|aws_secret|-----BEGIN)/i.test(s)}
function mode(){return $('#provider').value||'local'}
async function askSmart(userText){
  var payload={system:buildSystem(),history:historyForAPI(),userText:userText};
  var m=mode();

  async function tryRun(fn){try{var r=await fn(payload); if(r) return r}catch(e){return null} return null}

  if(m==='openai') return (await tryRun(callOpenAI)) || '(no reply)';
  if(m==='deepseek')return (await tryRun(callDeepSeek))||'(no reply)';
  if(m==='hf')     return (await tryRun(callHF))     || '(no reply)';
  if(m==='local')  { var r=await tryRun(callLocalWebLLM); if(r) return r; return await callLocalLite(payload) }
  if(m==='lite')   return await callLocalLite(payload);

  // auto chain
  var r=null;
  r=await tryRun(callOpenAI); if(r) return r;
  r=await tryRun(callDeepSeek); if(r) return r;
  r=await tryRun(callHF); if(r) return r;
  r=await tryRun(callLocalWebLLM); if(r) return r;
  return await callLocalLite(payload);
}

/* ---------- send/test ---------- */
var msgBox=document.getElementById('msg');
msgBox.addEventListener('keydown',function(e){ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}});
async function send(){
  var t=(msgBox.value||'').trim(); if(!t)return;
  if(looksLikeAKey(t)){alert('Blocked: that looks like a secret key.'); return;}
  msgBox.value=''; chat.push({role:'user',text:t}); render();
  // fast local commands handled here too
  if(t==='/help'||t==='/time'||t==='/coin'||/^\/echo /.test(t)||/^\/roll \d+d\d+$/i.test(t)||/^\/timer \d+(s|m)$/i.test(t)||/^\/sum /.test(t)){
    var reply=liteReply(t,''); chat.push({role:'bot',text:reply}); render(); if(speakReplies)speakText(reply); return;
  }
  try{
    var reply=await askSmart(t);
    chat.push({role:'bot',text:reply}); render(); if(speakReplies)speakText(reply); diag.textContent='';
  }catch(e){
    chat.push({role:'bot',text:'Error: '+(e&&e.message||e)}); render(); diag.textContent=(e&&e.message||e);
  }
}
async function testProvider(){diag.textContent='Testing‚Ä¶'; try{await askSmart('Say hi in one short sentence.'); diag.textContent='Provider OK ‚úÖ'}catch(e){diag.textContent='Provider error ‚ùå '+(e&&e.message||e)}}

/* ---------- sessions ---------- */
function sessionKey(id){return 'bb_session_'+id}
function loadSessionList(){try{return JSON.parse(localStorage.getItem('bb_sessions_v1')||'[]')}catch(e){return[]}}
function saveSessionList(list){localStorage.setItem('bb_sessions_v1',JSON.stringify(list))}
function refreshChatSelect(){var sel=$('#chatSelect'); var list=loadSessionList(); sel.innerHTML=''; var opt=document.createElement('option');opt.value='__current__';opt.textContent='(unsaved current chat)'; sel.appendChild(opt);
 for(var i=0;i<list.length;i++){var o=document.createElement('option');o.value=list[i].id;o.textContent=list[i].title; sel.appendChild(o)} sel.value=currentSessionId||'__current__'}
function newChat(){chat=[{role:'bot',text:'New chat. What should we do?'}]; currentSessionId=null; render(); refreshChatSelect()}
function saveChat(){var firstUser=''; for(var i=0;i<chat.length;i++){if(chat[i].role==='user'){firstUser=chat[i].text;break}} var title=prompt('Name this chat:',(firstUser||'Untitled').slice(0,40))||(firstUser||'Untitled').slice(0,40);
 var id=currentSessionId||String(Date.now()); localStorage.setItem(sessionKey(id),JSON.stringify(chat));
 var list=loadSessionList().filter(function(s){return s.id!==id}); list.unshift({id:id,title:title}); saveSessionList(list); currentSessionId=id; refreshChatSelect(); alert('Saved!')}
function deleteChat(){var sel=$('#chatSelect'); if(sel.value==='__current__'){alert('Select a saved chat to delete.');return}
 if(!confirm('Delete this saved chat?'))return; localStorage.removeItem(sessionKey(sel.value)); saveSessionList(loadSessionList().filter(function(s){return s.id!==sel.value})); currentSessionId=null; refreshChatSelect()}
$('#chatSelect').addEventListener('change',function(){var id=$('#chatSelect').value; if(id==='__current__'){currentSessionId=null;return}
 var raw=localStorage.getItem(sessionKey(id)); if(!raw){alert('Missing chat data');return} chat=JSON.parse(raw); currentSessionId=id; render()})
refreshChatSelect();
/* autosave */
function autosave(){try{localStorage.setItem('__bb_autosave__',JSON.stringify(chat))}catch(e){}}
var _render_original=render; render=function(){_render_original(); autosave()}
;(function(){var saved=localStorage.getItem('__bb_autosave__'); if(saved&&chat.length<=1){try{chat=JSON.parse(saved); render()}catch(e){}}})()
function downloadChat(){var lines=''; for(var i=0;i<chat.length;i++){lines+=chat[i].role.toUpperCase()+': '+chat[i].text+'\n\n'} var blob=new Blob([lines],{type:'text/plain'});
 var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='betterbot-chat.txt'; a.click(); setTimeout(function(){URL.revokeObjectURL(a.href)},1000)}

/* ---------- mic + tts ---------- */
var rec=null, listening=false;
function toggleMic(){var btn=$('#micBtn'); var SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){alert('Speech recognition not supported. Try Chrome.');return}
 if(!rec){rec=new SR(); rec.lang='en-AU'; rec.interimResults=true; rec.maxAlternatives=1;
   rec.onresult=function(e){var txt=''; for(var i=e.resultIndex;i<e.results.length;i++){txt+=e.results[i][0].transcript} $('#msg').value=txt};
   rec.onend=function(){listening=false; btn.textContent='üéôÔ∏è Mic'; btn.classList.remove('ghost'); btn.classList.add('secondary')};
   rec.onerror=function(){listening=false; btn.textContent='üéôÔ∏è Mic'; btn.classList.remove('ghost'); btn.classList.add('secondary')}} 
 if(!listening){try{rec.start(); listening=true; btn.textContent='üõë Stop'; btn.classList.remove('secondary'); btn.classList.add('ghost')}catch(e){}} else {try{rec.stop()}catch(e){} }}
function toggleTTS(){speakReplies=!speakReplies; $('#ttsBtn').textContent=speakReplies?'üîä Speak: On':'üîä Speak: Off'}
function speakText(t){try{speechSynthesis.cancel(); var u=new SpeechSynthesisUtterance(t); u.rate=1; u.pitch=1; u.lang='en-AU'; speechSynthesis.speak(u)}catch(e){}}

/* ---------- music ---------- */
var frame=$('#playerFrame'); function validUrl(u){try{var x=new URL(u); return x.protocol.indexOf('http')===0}catch(e){return false}}
function ensureEmbed(url){try{var u=new URL(url); if(u.hostname==='open.spotify.com'&&u.pathname.indexOf('/embed')!==0){u.pathname='/embed'+u.pathname; return u.toString()} return url}catch(e){return url}}
function setStation(u){var url=(u||'').trim(); if(!url){alert('Paste an embed URL.');return} url=ensureEmbed(url); if(!validUrl(url)){alert('Invalid URL');return} frame.src=url; localStorage.setItem('bb_station_url',url)}
;(function(){var last=localStorage.getItem('bb_station_url'); if(last) setStation(last); else setStation('https://www.youtube.com/embed/videoseries?list=PLMC9KNkIncKtPzgY-5rmhvj7fax8fdxoj')})()

/* ---------- theme toggle ---------- */
var blueOn=true; document.getElementById('blueBtn').onclick=function(){var r=document.documentElement.style;
 if(blueOn){r.setProperty('--accent','#9333ea'); r.setProperty('--accent2','#a855f7'); r.setProperty('--panel','#171421'); r.setProperty('--bg','#0c0a12'); this.textContent='Blue OFF'}
 else{r.setProperty('--accent','#1e3a8a'); r.setProperty('--accent2','#2563eb'); r.setProperty('--panel','#0f172a'); r.setProperty('--bg','#0b1022'); this.textContent='Blue ON'} blueOn=!blueOn}

/* ---------- PWA install + generator ---------- */
var deferredPrompt=null; window.addEventListener('beforeinstallprompt',function(e){e.preventDefault(); deferredPrompt=e; var b=$('#installBtn'); b.style.display=''; b.onclick=function(){if(!deferredPrompt)return; deferredPrompt.prompt(); deferredPrompt=null; b.style.display='none'}})
if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js').catch(function(){})}
document.getElementById('makePwaBtn').addEventListener('click',async function(){
 var filename=location.pathname.split('/').pop()||'app.html';
 var manifest={name:"BetterBot DC",short_name:"BetterBot DC",description:"Super app with manual memory and provider fallback.",start_url:".",scope:"./",display:"standalone",theme_color:"#0f172a",background_color:"#0f172a",icons:[{src:"icons/icon-192.png",sizes:"192x192",type:"image/png",purpose:"any maskable"},{src:"icons/icon-512.png",sizes:"512x512",type:"image/png",purpose:"any maskable"}]};
 var sw="const CACHE='betterbot-super-v1';const ASSETS=['./','"+filename+"','manifest.webmanifest','icons/icon-192.png','icons/icon-512.png'];self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS))) });self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k))))) });self.addEventListener('fetch',e=>{const url=new URL(e.request.url);const isAPI=/api\\.openai\\.com|api\\.deepseek\\.com|api-inference\\.huggingface\\.co/.test(url.host);if(isAPI)return; if(url.origin!==location.origin && !/\\.(css|js|png|jpg|jpeg|webp|svg)$/.test(url.pathname))return; e.respondWith(caches.match(e.request).then(c=>c||fetch(e.request).then(r=>{if(e.request.method==='GET'&&url.origin===location.origin){const copy=r.clone();caches.open(CACHE).then(c=>c.put(e.request,copy))}return r}))) })";
 function save(name,text,type){var blob=new Blob([text],{type:type||'text/plain'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(function(){URL.revokeObjectURL(a.href)},1000)}
 async function makePng(size){var c=document.createElement('canvas'); c.width=c.height=size; var x=c.getContext('2d'); x.fillStyle='#0f172a'; x.fillRect(0,0,size,size); x.beginPath(); x.arc(size/2,size/2,size*0.42,0,Math.PI*2); x.fillStyle='#2563eb'; x.fill(); x.fillStyle='#fff'; x.font=Math.round(size*0.28)+'px system-ui,-apple-system,Segoe UI,Roboto,sans-serif'; x.textAlign='center'; x.textBaseline='middle'; x.fillText('DC',size/2,size/2+size*0.02); return await new Promise(function(res){c.toBlob(res,'image/png')})}
 var icon192=await makePng(192), icon512=await makePng(512);
 save('manifest.webmanifest',JSON.stringify(manifest,null,2),'application/manifest+json'); save('service-worker.js',sw,'application/javascript');
 function saveBlob(blob,name){var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(function(){URL.revokeObjectURL(a.href)},1000)}
 saveBlob(icon192,'icon-192.png'); saveBlob(icon512,'icon-512.png'); alert('Downloaded manifest, service-worker, and icons. Create an "icons" folder next to this file, move icons there, then open via localhost/HTTPS for Install.')})

/* ---------- init ---------- */
(async function init(){
  setModeBadge('detecting‚Ä¶');
  // try to arm WebLLM quickly; if it fails we‚Äôll fall back to Lite in router
  try{ await ensureLocalWebLLM(); }catch(e){ localMode='lite'; setModeBadge('Local (Lite)') }
})();
</script><!-- BetterBot Pro Max: auto provider + remove Test + auto-start -->
<script>
(function () {
  // --- helpers to detect what we can use ---
  const $ = (s) => document.querySelector(s);
  const hasOpenAI = () => !!($('#oaKey')?.value || '').trim();
  const hasDS     = () => !!($('#dsKey')?.value || '').trim();
  const hasHF     = () => !!($('#hfKey')?.value || '').trim();
  const hasWebLLM = () => !!(window.webllm && window.webllm.CreateMLCEngine);

  function bestName() {
    if (hasOpenAI()) return 'OpenAI';
    if (hasDS())     return 'DeepSeek';
    if (hasHF())     return 'Hugging Face';
    if (hasWebLLM()) return 'Local (WebLLM)';
    return 'Local (Lite)';
  }

  // --- set dropdown to Auto and update badge text ---
  function setAutoModeUI() {
    const prov = document.getElementById('provider');
    if (prov) prov.value = 'auto';
    const badge = document.getElementById('modeBadge');
    if (badge) badge.textContent = 'Mode: Auto ‚Ä¢ Best = ' + bestName();
  }

  // --- remove any Test button in the UI ---
  function removeTestBtn() {
    const btn =
      document.querySelector('button[onclick="testProvider()"]') ||
      document.getElementById('testBtn') ||
      document.querySelector('button[data-role="test"]');
    if (btn) btn.remove();
  }

  // --- auto send a first message and render reply ---
  async function autoStart() {
    const first = "Hello " + (document.getElementById('name')?.value || "friend") + "! I‚Äôm BetterBot Pro Max ‚Äî ready to help.";

    // add as if user typed
    window.chat.push({ role: 'user', text: first });
    window.render();

    try {
      const reply = await window.askSmart(first);
      window.chat.push({ role: 'bot', text: reply });
      window.render();
      if (window.speakReplies) window.speakText(reply);
      document.getElementById('diag').textContent = '';
    } catch (e) {
      window.chat.push({ role: 'bot', text: '(startup error) ' + (e?.message || e) });
      window.render();
      document.getElementById('diag').textContent = (e?.message || e);
    }
  }

  // Run once page scripts are ready
  document.addEventListener('DOMContentLoaded', () => {
    setAutoModeUI();
    removeTestBtn();
  });

  // Give your existing init() a moment (WebLLM may still be loading), then start
  setTimeout(() => {
    setAutoModeUI();
    autoStart();
  }, 600);
})();
</script>

</body></html>
<script>
function setAutoModeUI() {
  const providerSel = document.getElementById('provider');
  if (providerSel) providerSel.value = "auto"; // force Pro Max auto chain
}

function removeTestBtn() {
  const btn = document.querySelector('button[onclick="testProvider()"]');
  if (btn && btn.parentNode) btn.parentNode.removeChild(btn);
}

async function autoStart() {
  try {
    const first = "Hello " + (document.getElementById('name')?.value || "friend") + 
                  "! I‚Äôm BetterBot Pro Max ‚Äî ready to help.";
    window.chat.push({ role: 'user', text: first });
    window.render();

    const reply = await window.askSmart(first);
    window.chat.push({ role: 'bot', text: reply });
    window.render();

    if (window.speakReplies) window.speakText(reply);
    document.getElementById('diag').textContent = '';
  } catch (e) {
    window.chat.push({ role: 'bot', text: '(startup error) ' + (e?.message || e) });
    window.render();
    document.getElementById('diag').textContent = (e?.message || e);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  setAutoModeUI();
  removeTestBtn();
});

// wait a moment for WebLLM init, then auto greet
setTimeout(() => {
  setAutoModeUI();
  autoStart();
}, 600);
</script>
<!-- ===== BetterBot: Loading + Sign-in Gate + Beta Advanced ===== -->
<script>
(function () {
  /* ---------- CONFIG ---------- */
  const GOOGLE_CLIENT_ID = "REPLACE_ME.apps.googleusercontent.com"; // get one at console.cloud.google.com (OAuth -> Web client)
  const BETA_EMAILS = ["Neeraj.raje@gmail.com"];                    // who gets Beta Advanced
  const LOGO_SRC = "DRAR%20CARS%20Logo%20on%20Speedway.png";        // your logo in repo (space-safe)

  /* ---------- STYLE ---------- */
  const css = `
  #bbGate{position:fixed;inset:0;background:#0b1022cc;backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:999999}
  #bbCard{width:min(560px,92vw);background:#0f172a;border:1px solid #1f2937;border-radius:18px;padding:18px;color:#e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.4)}
  #bbCard h3{margin:0 0 8px 0;font-size:18px}
  #bbLogo{display:block;margin:0 auto 10px auto;width:96px;height:96px;border-radius:18px;background:#0b1022 url("${LOGO_SRC}") center/cover no-repeat;border:1px solid #1f2937}
  #bbBar{height:10px;border-radius:999px;background:#111827;overflow:hidden;border:1px solid #1f2937}
  #bbFill{height:100%;width:0;background:linear-gradient(90deg,#2563eb,#60a5fa);transition:width .25s ease}
  #bbTip{margin-top:8px;font-size:12px;color:#93c5fd;text-align:center}
  #bbBtns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:14px}
  .bbBtn{padding:10px 14px;border-radius:12px;border:1px solid #223047;background:#0b1324;color:#e5e7eb;cursor:pointer}
  .bbBtn.primary{background:#2563eb;border-color:#1e40af}
  .bbMuted{font-size:12px;color:#94a3b8;text-align:center;margin-top:8px}
  #bbBetaBadge{margin-left:8px;padding:4px 8px;border-radius:999px;font-size:11px;background:#1d4ed81a;border:1px solid #1d4ed84d;color:#93c5fd}
  `;
  const st = document.createElement("style");
  st.textContent = css;
  document.head.appendChild(st);

  /* ---------- DOM ---------- */
  const gate = document.createElement("div");
  gate.id = "bbGate";
  gate.innerHTML = `
    <div id="bbCard">
      <div id="bbLogo"></div>
      <h3 style="text-align:center">Loading BetterBot‚Ä¶</h3>
      <div id="bbBar"><div id="bbFill"></div></div>
      <div id="bbTip">Tip: You can toggle Blue/Purple theme anytime.</div>
      <div id="bbBtns" style="display:none">
        <div id="gsiContainer"></div>
        <button id="bbGoogleBtn" class="bbBtn primary">Sign in with Google</button>
        <button id="bbPasskeyBtn" class="bbBtn" disabled title="Needs server; coming soon">Use Passkey</button>
      </div>
      <div class="bbMuted">Signing in lets you access Beta Advanced (whitelisted accounts only).</div>
    </div>`;
  document.body.appendChild(gate);

  /* ---------- PROGRESS + TIPS ---------- */
  const tips = [
    "Tip: Use /help for quick commands (timer, coin, roll, sum).",
    "Tip: Music station remembers your last link.",
    "Tip: ‚ÄòRemember last‚Äô saves a message into manual memory.",
    "Tip: Auto provider picks OpenAI ‚Üí DeepSeek ‚Üí HF ‚Üí Local."
  ];
  let i = 0, p = 0;
  const tipEl = document.getElementById("bbTip");
  const fill = document.getElementById("bbFill");
  const prog = setInterval(() => {
    p = Math.min(90, p + Math.random() * 8);
    fill.style.width = p + "%";
    tipEl.textContent = tips[i++ % tips.length];
  }, 700);

  /* ---------- AUTH STATE ---------- */
  function saveAuth(profile) { localStorage.setItem("__bb_auth__", JSON.stringify(profile)); }
  function loadAuth() { try { return JSON.parse(localStorage.getItem("__bb_auth__")||"null") } catch(e){ return null } }
  function isBeta(email) { return BETA_EMAILS.some(x => x.toLowerCase() === (email||"").toLowerCase()); }

  /* ---------- GOOGLE (GIS) ---------- */
  function loadGSI() {
    return new Promise(res => {
      const s = document.createElement("script");
      s.src = "https://accounts.google.com/gsi/client";
      s.async = true; s.defer = true; s.onload = res;
      document.head.appendChild(s);
    });
  }
  function parseJWT(token) {
    const payload = token.split(".")[1];
    const json = atob(payload.replace(/-/g,"+").replace(/_/g,"/"));
    return JSON.parse(decodeURIComponent(escape(json)));
  }
  async function initGoogle() {
    if (!GOOGLE_CLIENT_ID.startsWith("REPLACE_ME")) {
      await loadGSI();
      window.google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: (resp) => {
          try {
            const data = parseJWT(resp.credential);
            const profile = { email: data.email, name: data.name || data.given_name || "User", picture: data.picture, beta: isBeta(data.email) };
            saveAuth(profile);
            afterSignIn(profile);
          } catch(e) { alert("Google sign-in failed."); }
        }
      });
      // Button render for visual (still keep our fallback button)
      if (document.getElementById("gsiContainer")) {
        window.google.accounts.id.renderButton(document.getElementById("gsiContainer"), { theme: "outline", size: "large", shape:"pill", text:"continue_with", width: 260 });
      }
      document.getElementById("bbGoogleBtn").onclick = () => window.google.accounts.id.prompt();
    } else {
      // Dev fallback if no Client ID: prompt for email
      document.getElementById("bbGoogleBtn").onclick = () => {
        const email = prompt("Dev sign-in: enter your Google email (demo only)");
        if (!email) return;
        const profile = { email, name: email.split("@")[0], beta: isBeta(email) };
        saveAuth(profile); afterSignIn(profile);
      };
    }
  }

  /* ---------- AFTER SIGN-IN ---------- */
  function afterSignIn(profile) {
    // finish progress
    clearInterval(prog); fill.style.width = "100%";
    // set name field if present
    const nameInput = document.getElementById("name");
    if (nameInput && profile?.name) nameInput.value = profile.name;

    // Add/Update Beta badge in header
    const headerRow = document.querySelector(".header .row");
    if (headerRow && !document.getElementById("bbBetaBadge")) {
      const b = document.createElement("span");
      b.id = "bbBetaBadge";
      b.textContent = profile.beta ? "Beta Advanced ‚úì" : "Beta Locked";
      headerRow.appendChild(b);
    } else if (profile) {
      const b = document.getElementById("bbBetaBadge");
      if (b) b.textContent = profile.beta ? "Beta Advanced ‚úì" : "Beta Locked";
    }

    // Gate Beta-only actions: add a tiny guard function on window
    window.requireBeta = function () {
      const auth = loadAuth();
      if (auth?.beta) return true;
      alert("Beta Advanced is only available to approved accounts.\n\nPlease sign in with a beta-enabled Google account.");
      return false;
    };

    // hide gate
    setTimeout(() => { gate.remove(); }, 350);
  }

  /* ---------- SHOW SIGN-IN OR BYPASS ---------- */
  function showSignIn() {
    clearInterval(prog); fill.style.width = "92%";
    tipEl.textContent = "Sign in to continue (Google recommended).";
    document.getElementById("bbBtns").style.display = "";

    initGoogle(); // wires Google button (or dev fallback)
  }

  // If already signed in, skip straight through
  const existing = loadAuth();
  if (existing) {
    // put a badge immediately
    const headerReady = () => {
      const headerRow = document.querySelector(".header .row");
      if (!headerRow) return false;
      if (!document.getElementById("bbBetaBadge")) {
        const b = document.createElement("span"); b.id = "bbBetaBadge";
        b.textContent = existing.beta ? "Beta Advanced ‚úì" : "Beta Locked";
        headerRow.appendChild(b);
      }
      return true;
    };
    const i = setInterval(() => { if (headerReady()) { clearInterval(i); } }, 150);

    afterSignIn(existing);
  } else {
    // animate a bit, then ask to sign in
    setTimeout(showSignIn, 1600);
  }

  /* ---------- OPTIONAL: protect Beta UI pieces ----------
     Wrap any Beta-only features with:
       if (!window.requireBeta || !window.requireBeta()) return;
  ------------------------------------------------------- */
})();
</script>
<!-- ===== Beta Advanced: enable for any Google sign-in + toggle panel ===== -->
<script>
(function () {
  /* ---------- auth helpers (match your gate storage) ---------- */
  const AUTH_KEY = "__bb_auth__";
  const getAuth = () => { try { return JSON.parse(localStorage.getItem(AUTH_KEY) || "null"); } catch { return null; } };
  const setAuth = (obj) => localStorage.setItem(AUTH_KEY, JSON.stringify(obj || null));

  /* ---------- styles for the panel ---------- */
  const css = `
  #bbBetaBtn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:12px;
             background:#1f2937;border:1px solid #334155;color:#e5e7eb;cursor:pointer}
  #bbBetaPanel{position:fixed;inset:auto 12px 12px auto; right:12px; bottom:12px;
               width:min(420px,92vw); background:#0f172a; color:#e5e7eb; border:1px solid #1f2937;
               border-radius:14px; padding:14px; box-shadow:0 12px 28px rgba(0,0,0,.35); display:none; z-index:99998}
  #bbBetaPanel h4{margin:0 0 8px 0;font-size:16px}
  #bbBetaClose{float:right; cursor:pointer; opacity:.8}
  #bbBetaPanel .row{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0}
  #bbBetaPanel .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#1d4ed81a;border:1px solid #1d4ed84d}
  `;
  const st = document.createElement('style'); st.textContent = css; document.head.appendChild(st);

  /* ---------- build panel UI ---------- */
  function ensurePanel() {
    if (document.getElementById('bbBetaPanel')) return;
    const panel = document.createElement('div');
    panel.id = 'bbBetaPanel';
    panel.innerHTML = `
      <div>
        <span id="bbBetaClose">‚úñ</span>
        <h4>Beta Advanced</h4>
        <div class="row">
          <span class="pill">Auto Provider: OpenAI ‚Üí DeepSeek ‚Üí HF ‚Üí Local ‚Üí Lite</span>
          <span class="pill">Manual Memory tools enabled</span>
        </div>
        <div class="row">
          <button id="bbForceAuto" class="pill" style="cursor:pointer">Force Auto Mode</button>
          <button id="bbClearAuth" class="pill" style="cursor:pointer">Sign out</button>
        </div>
        <div style="font-size:12px;opacity:.8;margin-top:6px">Signed in as: <span id="bbWho"></span></div>
      </div>`;
    document.body.appendChild(panel);

    // wire actions
    panel.querySelector('#bbBetaClose').onclick = () => panel.style.display = 'none';
    panel.querySelector('#bbForceAuto').onclick = () => {
      const sel = document.getElementById('provider');
      if (sel) sel.value = 'auto';
      alert('Provider set to Auto (Pro Max).');
    };
    panel.querySelector('#bbClearAuth').onclick = () => {
      localStorage.removeItem(AUTH_KEY);
      alert('Signed out. Reloading‚Ä¶');
      location.reload();
    };
  }

  function openPanel() {
    ensurePanel();
    const who = getAuth();
    const whoEl = document.getElementById('bbWho');
    if (whoEl) whoEl.textContent = (who?.email || who?.name || 'unknown');
    const p = document.getElementById('bbBetaPanel');
    if (p) p.style.display = 'block';
  }

  /* ---------- show button in header when signed in ---------- */
  function ensureButton() {
    if (document.getElementById('bbBetaBtn')) return;
    const row = document.querySelector('.header .row');
    if (!row) return;
    const btn = document.createElement('button');
    btn.id = 'bbBetaBtn';
    btn.innerHTML = 'Beta Advanced';
    btn.onclick = openPanel;
    row.appendChild(btn);
  }

  /* ---------- main: upgrade auth to beta if signed in ---------- */
  function promoteAnyGoogleToBeta() {
    const a = getAuth();
    if (!a) return false;
    // If user has an email (Google sign-in), grant beta
    if (a.email && !a.beta) {
      a.beta = true;
      setAuth(a);
    }
    return true;
  }

  /* ---------- startup loop: wait until gate saves auth, then patch ---------- */
  let tries = 0;
  const tick = setInterval(() => {
    tries++;
    const hasAuth = promoteAnyGoogleToBeta();
    if (hasAuth) {
      // add ‚ÄúBeta Advanced‚Äù controls
      ensurePanel();
      ensureButton();
      // also adjust header badge text if the gate added one
      const badge = document.getElementById('bbBetaBadge');
      if (badge) badge.textContent = 'Beta Advanced ‚úì';
      clearInterval(tick);
    }
    if (tries > 60) clearInterval(tick); // ~9s safety
  }, 150);
})();
</script>
<!-- BetterBot: consolidated Pro Max (single greet, no tests, no dups) -->
<script>
(function () {
  // prevent double-run if pasted twice
  if (window.__bb_pro_max_once__) return;
  window.__bb_pro_max_once__ = true;

  const $ = (s) => document.querySelector(s);

  // 1) Force Auto mode + clean badge
  const prov = document.getElementById('provider');
  if (prov) prov.value = 'auto';
  const badge = document.getElementById('modeBadge');
  if (badge) badge.textContent = 'Mode: Auto';

  // 2) Remove/hide any Test button
  (document.querySelector('button[onclick="testProvider()"]')
    || document.getElementById('testBtn')
    || document.querySelector('button[data-role="test"]'))?.remove();
  // if some code still calls testProvider(), neutralize it
  if (typeof window.testProvider === 'function') {
    window.testProvider = () => { const d=$('#diag'); if (d) d.textContent=''; };
  }

  // 3) Remove the stock welcome bubble if it exists as first message
  try {
    if (Array.isArray(window.chat) && window.chat.length) {
      const first = (window.chat[0]?.text || '').toLowerCase();
      if (first.includes("hi!") && first.includes("i'm betterbot")) {
        window.chat.shift();
        if (typeof window.render === 'function') window.render();
      }
    }
  } catch(_) {}

  // 4) Temporary guard to block duplicate auto-greets from earlier snippets
  let suppress = true;
  if (Array.isArray(window.chat)) {
    const origPush = window.chat.push;
    window.chat.push = function (msg) {
      if (suppress && msg && msg.role === 'user' &&
          /i[‚Äô']?m betterbot pro max/i.test(msg.text || '')) {
        return window.chat.length; // drop duplicate
      }
      return origPush.apply(window.chat, arguments);
    };
    // stop suppressing after startup settles
    setTimeout(() => { suppress = false; }, 2000);
  }

  // 5) Single greeting (once) after page settles ‚Äî no test prompts
  setTimeout(async () => {
    try {
      const name = $('#name')?.value || 'friend';
      const first = `Hello ${name}! I‚Äôm BetterBot Pro Max ‚Äî ready to help.`;

      // add as if user typed
      if (Array.isArray(window.chat)) { window.chat.push({ role:'user', text:first }); }
      if (typeof window.render === 'function') window.render();

      // ask via your router (no explicit provider tests here)
      const reply = await window.askSmart(first);
      if (Array.isArray(window.chat)) { window.chat.push({ role:'bot', text:reply }); }
      if (typeof window.render === 'function') window.render();
      const diag = $('#diag'); if (diag) diag.textContent = '';
      if (window.speakReplies) { try { window.speakText(reply); } catch(_) {} }
    } catch (e) {
      if (Array.isArray(window.chat)) {
        window.chat.push({ role:'bot', text:'(startup error) ' + (e?.message || e) });
      }
      if (typeof window.render === 'function') window.render();
      const diag = $('#diag'); if (diag) diag.textContent = (e?.message || e);
    }
  }, 600);
})();
</script>
<!-- BetterBot: consolidated Pro Max (single greet, no tests, no dups) -->
<script>
(function () {
  // prevent double-run if pasted twice
  if (window.__bb_pro_max_once__) return;
  window.__bb_pro_max_once__ = true;

  const $ = (s) => document.querySelector(s);

  // 1) Force Auto mode + clean badge
  const prov = document.getElementById('provider');
  if (prov) prov.value = 'auto';
  const badge = document.getElementById('modeBadge');
  if (badge) badge.textContent = 'Mode: Auto';

  // 2) Remove/hide any Test button
  (document.querySelector('button[onclick="testProvider()"]')
    || document.getElementById('testBtn')
    || document.querySelector('button[data-role="test"]'))?.remove();
  // if some code still calls testProvider(), neutralize it
  if (typeof window.testProvider === 'function') {
    window.testProvider = () => { const d=$('#diag'); if (d) d.textContent=''; };
  }

  // 3) Remove the stock welcome bubble if it exists as first message
  try {
    if (Array.isArray(window.chat) && window.chat.length) {
      const first = (window.chat[0]?.text || '').toLowerCase();
      if (first.includes("hi!") && first.includes("i'm betterbot")) {
        window.chat.shift();
        if (typeof window.render === 'function') window.render();
      }
    }
  } catch(_) {}

  // 4) Temporary guard to block duplicate auto-greets from earlier snippets
  let suppress = true;
  if (Array.isArray(window.chat)) {
    const origPush = window.chat.push;
    window.chat.push = function (msg) {
      if (suppress && msg && msg.role === 'user' &&
          /i[‚Äô']?m betterbot pro max/i.test(msg.text || '')) {
        return window.chat.length; // drop duplicate
      }
      return origPush.apply(window.chat, arguments);
    };
    // stop suppressing after startup settles
    setTimeout(() => { suppress = false; }, 2000);
  }

  // 5) Single greeting (once) after page settles ‚Äî no test prompts
  setTimeout(async () => {
    try {
      const name = $('#name')?.value || 'friend';
      const first = `Hello ${name}! I‚Äôm BetterBot Pro Max ‚Äî ready to help.`;

      // add as if user typed
      if (Array.isArray(window.chat)) { window.chat.push({ role:'user', text:first }); }
      if (typeof window.render === 'function') window.render();

      // ask via your router (no explicit provider tests here)
      const reply = await window.askSmart(first);
      if (Array.isArray(window.chat)) { window.chat.push({ role:'bot', text:reply }); }
      if (typeof window.render === 'function') window.render();
      const diag = $('#diag'); if (diag) diag.textContent = '';
      if (window.speakReplies) { try { window.speakText(reply); } catch(_) {} }
    } catch (e) {
      if (Array.isArray(window.chat)) {
        window.chat.push({ role:'bot', text:'(startup error) ' + (e?.message || e) });
      }
      if (typeof window.render === 'function') window.render();
      const diag = $('#diag'); if (diag) diag.textContent = (e?.message || e);
    }
  }, 600);
})();
</script>
  <!-- ===== BetterBot: Provider Launcher (No-API Keys) ===== -->
  <div class="card">
    <h3>üöÄ Provider Launcher (no API keys)</h3>
    <p class="muted">
      This card helps you take your Title/Style/Voice/Lyrics and send them to external AI providers.  
      Options: Copy prompt, download prompt, download lyrics, or open a provider (auto-copies prompt).
    </p>

    <div style="margin:8px 0;">
      <button onclick="copyPrompt()">üìã Copy Prompt</button>
      <button onclick="downloadPrompt()">‚¨áÔ∏è Download Prompt</button>
      <button onclick="downloadLyrics()">‚¨áÔ∏è Download Lyrics</button>
      <span id="prov-msg" class="muted"></span>
    </div>

    <h4>üé∂ Music / Song Generators</h4>
    <ul>
      <li><a href="#" onclick="openProvider('https://www.udio.com/'); return false;">Udio</a></li>
      <li><a href="#" onclick="openProvider('https://suno.com/'); return false;">Suno</a></li>
      <li><a href="#" onclick="openProvider('https://www.beatoven.ai/'); return false;">Beatoven</a></li>
      <li><a href="#" onclick="openProvider('https://soundraw.io/'); return false;">SOUNDRAW</a></li>
    </ul>

    <h4>üñºÔ∏è Image / Cover Art</h4>
    <ul>
      <li><a href="#" onclick="openProvider('https://playground.com/'); return false;">Playground AI</a></li>
      <li><a href="#" onclick="openProvider('https://lexica.art/'); return false;">Lexica</a></li>
      <li><a href="#" onclick="openProvider('https://www.craiyon.com/'); return false;">Craiyon</a></li>
    </ul>

    <h4>üéûÔ∏è Video Tools</h4>
    <ul>
      <li><a href="#" onclick="openProvider('https://pika.art/'); return false;">Pika Labs</a></li>
      <li><a href="#" onclick="openProvider('https://runwayml.com/'); return false;">Runway</a></li>
      <li><a href="#" onclick="openProvider('https://www.capcut.com/'); return false;">CapCut Web</a></li>
      <li><a href="#" onclick="openProvider('https://www.canva.com/'); return false;">Canva</a></li>
    </ul>
  </div>

  <script>
    // Build a prompt from current form values
    function buildPrompt(){
      const title  = (document.getElementById('msc-title')?.value || 'Untitled').trim();
      const style  = (document.getElementById('msc-style')?.value || 'pop').trim();
      const voice  = (document.getElementById('msc-voice')?.value || 'female').trim();
      const lyrics = (document.getElementById('msc-lyrics')?.value || '').trim();

      const lines = [];
      lines.push(`Create a ${style} song titled "${title}" with ${voice} vocals.`);
      lines.push(`Keep it clean, uplifting, and family-friendly.`);
      if (lyrics) {
        lines.push(`Use these lyrics (line-preserving):\n${lyrics}`);
      } else {
        lines.push(`Generate simple, positive, singable lyrics about shining again.`);
      }
      return lines.join('\n');
    }

    // Copy prompt only
    async function copyPrompt(){
      const prompt = buildPrompt();
      try {
        await navigator.clipboard.writeText(prompt);
        setMsg("üìã Prompt copied to clipboard.");
      } catch {
        setMsg("‚ö†Ô∏è Could not copy. Use ‚¨áÔ∏è Download Prompt instead.");
      }
    }

    // Open provider and auto-copy prompt
    async function openProvider(url){
      const prompt = buildPrompt();
      try {
        await navigator.clipboard.writeText(prompt);
        setMsg("‚úÖ Prompt copied. Opening provider‚Ä¶");
      } catch {
        setMsg("‚ö†Ô∏è Could not copy. Use ‚¨áÔ∏è Download Prompt.");
      }
      window.open(url, '_blank', 'noopener,noreferrer');
    }

    // Download prompt as text file
    function downloadPrompt(){
      const prompt = buildPrompt();
      downloadText('prompt.txt', prompt);
      setMsg("‚¨áÔ∏è prompt.txt downloaded.");
    }

    // Download lyrics as text file
    function downloadLyrics(){
      const lyrics = (document.getElementById('msc-lyrics')?.value || '').trim();
      if (!lyrics) { setMsg("‚ö†Ô∏è No lyrics to download."); return; }
      downloadText('lyrics.txt', lyrics);
      setMsg("‚¨áÔ∏è lyrics.txt downloaded.");
    }

    // Helpers
    function downloadText(filename, text){
      const blob = new Blob([text], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function setMsg(t){
      const el = document.getElementById('prov-msg');
      if (!el) return;
      el.textContent = t;
      setTimeout(()=>{ el.textContent = ""; }, 3000);
    }
  </script>
  <!-- ===== End Provider Launcher ===== -->
    <script>
    // === CANCEL OLD PROVIDER LAUNCHER IF PRESENT ===
    document.addEventListener("DOMContentLoaded", () => {
      // Find any old Provider Launcher cards and remove them
      document.querySelectorAll(".card h3").forEach(h3 => {
        if (h3.textContent.includes("Provider Launcher")) {
          h3.parentElement.remove();
        }
      });

      // === NEW PROVIDER LAUNCHER CARD ===
      const uploadCard = Array.from(document.querySelectorAll(".card h3"))
        .find(h3 => h3.textContent.includes("Upload a File"));
      if (!uploadCard) return;

      const container = uploadCard.parentElement;
      const newCard = document.createElement("div");
      newCard.className = "card";
      newCard.innerHTML = `
        <h3>üöÄ Provider Launcher (no API keys)</h3>
        <p class="muted">
          Take your Title/Style/Voice/Lyrics and send them to external AI providers.<br>
          Options: Copy prompt, download prompt, download lyrics, or open a provider (auto-copies prompt).
        </p>

        <div style="margin:8px 0;">
          <button onclick="copyPrompt()">üìã Copy Prompt</button>
          <button onclick="downloadPrompt()">‚¨áÔ∏è Download Prompt</button>
          <button onclick="downloadLyrics()">‚¨áÔ∏è Download Lyrics</button>
          <span id="prov-msg" class="muted"></span>
        </div>

        <h4>üé∂ Music / Song Generators</h4>
        <ul>
          <li><a href="#" onclick="openProvider('https://www.udio.com/'); return false;">Udio</a></li>
          <li><a href="#" onclick="openProvider('https://suno.com/'); return false;">Suno</a></li>
          <li><a href="#" onclick="openProvider('https://www.beatoven.ai/'); return false;">Beatoven</a></li>
          <li><a href="#" onclick="openProvider('https://soundraw.io/'); return false;">SOUNDRAW</a></li>
        </ul>

        <h4>üñºÔ∏è Image / Cover Art</h4>
        <ul>
          <li><a href="#" onclick="openProvider('https://playground.com/'); return false;">Playground AI</a></li>
          <li><a href="#" onclick="openProvider('https://lexica.art/'); return false;">Lexica</a></li>
          <li><a href="#" onclick="openProvider('https://www.craiyon.com/'); return false;">Craiyon</a></li>
        </ul>

        <h4>üéûÔ∏è Video Tools</h4>
        <ul>
          <li><a href="#" onclick="openProvider('https://pika.art/'); return false;">Pika Labs</a></li>
          <li><a href="#" onclick="openProvider('https://runwayml.com/'); return false;">Runway</a></li>
          <li><a href="#" onclick="openProvider('https://www.capcut.com/'); return false;">CapCut Web</a></li>
          <li><a href="#" onclick="openProvider('https://www.canva.com/'); return false;">Canva</a></li>
        </ul>
      `;
      container.insertAdjacentElement("afterend", newCard);
    });

    // === Shared Helper Functions ===
    function buildPrompt(){
      const title  = (document.getElementById('msc-title')?.value || 'Untitled').trim();
      const style  = (document.getElementById('msc-style')?.value || 'pop').trim();
      const voice  = (document.getElementById('msc-voice')?.value || 'female').trim();
      const lyrics = (document.getElementById('msc-lyrics')?.value || '').trim();

      const lines = [];
      lines.push(\`Create a \${style} song titled "\${title}" with \${voice} vocals.\`);
      lines.push("Keep it clean, uplifting, and family-friendly.");
      if (lyrics) {
        lines.push("Use these lyrics (line-preserving):\\n" + lyrics);
      } else {
        lines.push("Generate simple, positive, singable lyrics about shining again.");
      }
      return lines.join('\\n');
    }

    async function copyPrompt(){
      const prompt = buildPrompt();
      try {
        await navigator.clipboard.writeText(prompt);
        setMsg("üìã Prompt copied to clipboard.");
      } catch {
        setMsg("‚ö†Ô∏è Could not copy. Use ‚¨áÔ∏è Download Prompt instead.");
      }
    }

    async function openProvider(url){
      const prompt = buildPrompt();
      try {
        await navigator.clipboard.writeText(prompt);
        setMsg("‚úÖ Prompt copied. Opening provider‚Ä¶");
      } catch {
        setMsg("‚ö†Ô∏è Could not copy. Use ‚¨áÔ∏è Download Prompt.");
      }
      window.open(url, '_blank', 'noopener,noreferrer');
    }

    function downloadPrompt(){
      const prompt = buildPrompt();
      downloadText('prompt.txt', prompt);
      setMsg("‚¨áÔ∏è prompt.txt downloaded.");
    }

    function downloadLyrics(){
      const lyrics = (document.getElementById('msc-lyrics')?.value || '').trim();
      if (!lyrics) { setMsg("‚ö†Ô∏è No lyrics to download."); return; }
      downloadText('lyrics.txt', lyrics);
      setMsg("‚¨áÔ∏è lyrics.txt downloaded.");
    }

    function downloadText(filename, text){
      const blob = new Blob([text], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function setMsg(t){
      const el = document.getElementById('prov-msg');
      if (!el) return;
      el.textContent = t;
      setTimeout(()=>{ el.textContent = ""; }, 3000);
    }
  </script>
</body></html>
